# mod_authn_hpc_acct

How does a new user authenticate in order to set his initial password?  The assignment of an initial password is possible, with the credentials communicated to the user out-of-band.  What if that user doesn't bother changing the password?  What happens if the password leaks during the communication process and there is no expiration on it?

We had the ideal situation with XSEDE/ACCESS users:  the XSEDE/ACCESS InCommon IdP could be used to authenticate the user and their released attributes were sufficient to tie them to their DARWIN account.  We didn't have to assign an initial password in the first place.  But seeing as we _are_ the authority in this case, there is no such fallback IdP.

What would be desirable is a short-term proxy credential that could be relied upon to identity the remote client of a web application.

## The identity token

In the context of this module an *identity token* is a string with the format:

```
[HPC_ID_TOKEN|<uid>|<uid#>|<ldap-dn>|<expiration-timestamp>]
```

This token would be generated by some agent (an IT-RCI support person, perhaps) and then encrypted using a pre-shared password and method.  For example:

```
[PROMPT]$ cat token.raw
[HPC_ID_TOKEN|frey|1001|uid=frey,ou=People,dc=hpc,dc=udel,dc=edu|1761868800]

[PROMPT]$ openssl enc -aes-256-cbc -salt -iter 1000 -pbkdf2 -md sha256 \
                      -pass pass:'this is my passw0rd' -base64 -A \
                      -in ./token.raw -p -out ./token.enc
salt=0AEA52546BF2FD04
key=E4FCB78C122316D6F16B8C87112A95E1929B48358EEFEC84065C6393B0416A47
iv =E52D1B367E1CFF6972DFEEE575A545F9

[PROMPT]$ cat token.enc | tr '+/' '-_'
U2FsdGVkX18K6lJUa_L9BA3PQYRjEJqTJExPRId90HCWm-l7hOs7gl0eoAU5-1fMh4l9Yy5QcdXuksBZai2INOJoPilH70g5RZMYSeuiqpsiZ4i4t1zZuNQi6QuC1FOs
```

The `tr` command is present to convert the base64 encoding to base64url encoding that can be embedded in a URL.

### Accompanying configuration

The `openssl` command shown above would yield the following Apache configuration directives:

```
<Location /account/initial-password/>
    AuthType Basic
    AuthBasicProvider hpc-acct
    AuthName "UD-HPC Initial Password Reset"

    AuthnHPCAcctEnable On
    AuthnHPCAcctEncryptMethod aes_256_cbc sha256
    AuthnHPCAcctEncryptIterCount 1000
    AuthnHPCAcctUsePBKDF2 On
    AuthnHPCAcctEncryptPassword "this is my passw0rd"
</Location>
```

The module uses the path associated with the enclosing location as its base URI path; this could be made explicit by adding

```
    AuthnHPCAcctBaseUriPath "/account/initial-password"
```

to the directives.

## Authentication

The module implements authentication of the encrypted identity token by hooking into the request-processing pipeline once the URI has been decoded and mapped — and before any authentication/authorization has happened.  If the requested URI is rooted under the directory/location at which the module is configured and enabled, then the *first path component of the URI fragment* is taken to be the base64url-encoded encrypted identity token.  That token is paired with a random username constructed at server startup and a basic **Authorization** header synthesized and added to the request headers.

Once the authentication phase is triggered on the request the module's callback is given the username and password pulled from that **Authorization** header.  If the username matches the randomized one constructed at server startup, then an attempt is made to decrypt the password (which was set to the encrypted identity token).  If successful, the expiration timestamp on the token is validated against the server's current time.  If successful, then the request's authenticated user is set and additional request headers may be set to the token fields:

- `X-HPC-ACCT-TOKEN-UID` set to the token's uid (or set via `AuthnHPCAcctSetUidHeader`)
- `X-HPC-ACCT-TOKEN-UIDNUMBER` set to the token's uid# (or set via `AuthnHPCAcctSetUidNumberHeader`)
- `X-HPC-ACCT-TOKEN-LDAPDN` set to the token's LDAP DN (or set via `AuthnHPCAcctSetLDAPDNHeader`)

## Building the module

The module can be compiled using `apxs`:

```
[PROMPT]$ apxs -c mod_authn_hpc_acct.c
```

Doing compilation alone allows you to test whether it will compile properly.  Once you're verified the code build properly, it can be installed:

```
[PROMPT]$ apxs -i -c mod_authn_hpc_acct.c
```

Include the `-a` flag to automatically add the `LoadModule` statement to the server configuration — I prefer to do that myself using a config fragment under e.g. `/etc/httpd/conf.modules.d`.


## Configuration directives

The module implements the following Apache configuration directives:

| Directive | Discussion | Default value |
| :-------- | :--------- | :------------ |
| `AuthnHPCAcctEnable` | Set to `on` to use this module to authenticate on this path, `off` to disable | `on` |
| `AuthnHPCAcctSetUidHeader` | Request header that should be set to the uid from the identity token | `X-HPC-ACCT-TOKEN-UID` |
| `AuthnHPCAcctSetUidNumberHeader` | Request header that should be set to the uid# from the identity token | `X-HPC-ACCT-TOKEN-UID-NUMBER` |
| `AuthnHPCAcctSetLDAPDNHeader` | Request header that should be set to the LDAP DN from the identity token | `X-HPC-ACCT-TOKEN-LDAP-DN` |
| `AuthnHPCAcctEncryptMethod` | Two arguments:  the encryption cipher algorithm and digest | `aes_256_cbc` `sha1` |
| `AuthnHPCAcctEncryptIterCount` | Encryption iteration count (an integer > 0) | `1000` |
| `AuthnHPCAcctEncryptPassword` | Encryption password.  An optional first argument specifies the type (`base64` or `text`) and is followed by the password as a second argument; providing a single argument implied `text`.  A `text` password is used as-is while a `base64` password is first decoded. | none |
| `AuthnHPCAcctEncryptPasswordFile` | Read the encryption password from a file.  An optional first argument specifies the type (`base64`, `text`, or `bytes`) and is followed by the file path as a second argument; providing a single argument implied `bytes`.  A `bytes` password is used as-is from the file while `text` will have leading and trailing whitespace stripped from it.  A `base64` password is stripped of whitespace and decoded. | none |
| `AuthnHPCAcctBaseUriPath` | Override the base URI path that prefixes the identity token path component | The URI path associated with the location/directory at which the configuration is made |
| `AuthnHPCAcctUsePBKDF2` | Set to `off` to disable PBKDF2 key generation | `on` |

Either the `AuthnHPCAcctEncryptPassword` or `AuthnHPCAcctEncryptPasswordFile` must be present.
